name: Verify cdxgen pre-release
on:
    workflow_dispatch:
        inputs:
            cdxgen_repo:
                required: false
                description: Repository (cdxgen or fork of https://github.com/CycloneDX/cdxgen/) to run tests with
                default: CycloneDX/cdxgen
            cdxgen_branch:
                required: true
                description: Branch of cdxgen_repo to run tests with
env:
    CDXGEN_PLUGINS_VERSION: '1.4.0'
    GRYPE_VERSION: '0.73.4'
    SBOMQS_VERSION: 'v0.0.28'
    java_version: '21'
    mvn_parameter: '-B -ntp'
    cdxgen_branch: ${{ github.event.inputs.cdxgen_branch }}
    cdxgen_repo: ${{ github.event.inputs.cdxgen_repo }}
jobs:
    verify:
        name: Verify cdxgen pre-release from branch
        runs-on: ubuntu-latest
        steps:

            - name: Checkout Code
              uses: actions/checkout@v4

            - name: Setup Java
              uses: actions/setup-java@v4
              with:
                  java-version: '${{ env.java_version }}'
                  distribution: 'temurin'

            - name: Install requirements and cdxgen from repo ${{env.cdxgen_repo}} branch ${{ env.cdxgen_branch }}
              run: |
                  mkdir _bin
                  echo $(pwd)/_bin >> $GITHUB_PATH

                  # cdxgen
                  git clone -b "$cdxgen_branch" "https://github.com/${cdxgen_repo}.git" cdxgen
                  cd cdxgen
                  npm install
                  cd ..
                  ln -s $(realpath cdxgen/bin/cdxgen.js) _bin/cdxgen

                  # cdxgen-plugins-bin
                  npm install -g @cyclonedx/cdxgen-plugins-bin@${CDXGEN_PLUGINS_VERSION}

                  echo "Install grype"
                  GRYPE_URL="https://github.com/anchore/grype/releases/download/v${GRYPE_VERSION}"
                  curl -Ls "$GRYPE_URL/grype_${GRYPE_VERSION}_linux_amd64.tar.gz" -o grype.tar.gz
                  curl -Ls "$GRYPE_URL/grype_${GRYPE_VERSION}_checksums.txt" -o grype_checksums.txt
                  if ! grep -q "$(sha256sum grype.tar.gz | cut -d' ' -f1)" grype_checksums.txt; then
                      echo "::error title=Invalid checksum::grype ${GRYPE_VERSION}"
                      exit 1
                  fi
                  tar xf grype.tar.gz -C _bin

                  echo "Install sbomqs"
                  SBOMQS_URL="https://github.com/interlynk-io/sbomqs/releases/download/v${SBOMQS_VERSION}"
                  curl -Ls "$SBOMQS_URL/sbomqs-linux-amd64" -o sbomqs
                  curl -Ls "$SBOMQS_URL/sbomqs_${SBOMQS_VERSION}_checksums.txt" -o sbomqs_checksums.txt
                  if ! grep -q "$(sha256sum sbomqs | cut -d' ' -f1)" sbomqs_checksums.txt; then
                      echo "::error title=Invalid checksum::sbomqs ${SBOMQS_VERSION}"
                      exit 1
                  fi
                  mv sbomqs _bin/sbomqs
                  chmod a+x _bin/sbomqs

            - name: Application Build and Test with cdxgen branch ${{ env.cdxgen_branch }}
              env:
                  QUARKUS_GITHUB_APP_APP_ID: 32168
                  QUARKUS_GITHUB_APP_WEBHOOK_SECRET: for-my-eyes-only
                  QUARKUS_GITHUB_APP_PRIVATE_KEY: ''
                  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
                  DTRACK_APIKEY: theres-nothing-to-see-here
              run: mvn ${{ env.mvn_parameter }} clean verify
